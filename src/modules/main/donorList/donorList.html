<template>
  <div class={containerClass}>
    
    <!-- Global Header -->
    <header class="slds-col slds-size_1-of-1 global-header">
      <div class="slds-grid slds-grid_align-spread slds-p-horizontal_medium slds-p-vertical_x-small" style="height: 100%;">
        
        <!-- Logo -->
        <div class="slds-grid slds-grid_vertical-align-center">
          <svg width="46" height="32" viewBox="0 0 61 42" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M25.524 4.65374C27.5144 2.6759 30.2073 1.39612 33.2514 1.39612C37.2322 1.39612 40.7447 3.60665 42.618 6.86427C44.2572 6.1662 46.0134 5.70083 47.8868 5.70083C55.1459 5.70083 61 11.518 61 18.7313C61 25.9446 55.1459 31.7618 47.8868 31.7618C46.9501 31.7618 46.1305 31.6454 45.3109 31.5291C43.6718 34.4377 40.5106 36.4155 36.881 36.4155C35.3589 36.4155 33.9539 36.0665 32.666 35.4848C31.0269 39.3241 27.1631 42 22.5969 42C17.9136 42 13.8157 39.0914 12.2937 34.903C11.5912 35.0194 10.8887 35.1357 10.1862 35.1357C4.56622 35.1357 0 30.5983 0 25.0139C0 21.2909 1.9904 18.0332 5.03455 16.2881C4.44914 14.892 4.09789 13.2632 4.09789 11.6343C4.09789 5.23546 9.3666 0 15.9232 0C20.0211 0.116343 23.4165 1.8615 25.524 4.65374Z" fill="#00A1E0"/>
          </svg>
        </div>

        <!-- Global Search -->
        <div class="slds-grid slds-grid_vertical-align-center slds-grid_align-center slds-grow">
          <div class="slds-form-element" style="width: 500px;">
            <div class="slds-form-element__control slds-input-has-icon slds-input-has-icon_left">
              <lightning-icon icon-name="utility:search" size="x-small" class="slds-input__icon slds-input__icon_left"></lightning-icon>
              <input type="search" class="slds-input" placeholder="Search..." />
            </div>
          </div>
        </div>

        <!-- Utility Icons -->
        <div class="slds-grid slds-grid_vertical-align-center">
          <lightning-button-icon icon-name="utility:notification" variant="container" alternative-text="Notifications" class="slds-m-right_x-small"></lightning-button-icon>
          <lightning-button-icon icon-name="utility:help" variant="container" alternative-text="Help" class="slds-m-right_x-small"></lightning-button-icon>
          <lightning-button-icon icon-name="utility:settings" variant="container" alternative-text="Settings" class="slds-m-right_x-small"></lightning-button-icon>
          <div class="agentforce-icon-container">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14.534 12.7477H14.5432C14.1648 12.78 13.8278 12.8446 13.5371 12.9369C13.5371 12.9369 13.1125 13.0708 12.4617 13.1631C12.3094 13.1862 12.1155 13.1862 12.0094 13.1862H11.9309C11.8248 13.1862 11.6263 13.1769 11.4786 13.1539C10.8278 13.0477 10.4078 12.9 10.4078 12.9C10.1171 12.8077 9.78015 12.7385 9.40169 12.6969C7.32938 12.4846 6.434 13.2739 6.38323 13.4216C6.33246 13.5692 6.55861 15.4892 6.72477 15.7939C6.8863 16.0939 7.13554 16.2692 7.36169 16.3662C7.59246 16.4631 9.48938 16.6523 10.1217 16.5646C10.754 16.4769 10.8509 16.2646 11.0217 15.9416C11.1417 15.7108 11.4509 14.6677 11.6217 14.0539C11.6632 13.9339 11.6678 13.6939 11.9586 13.6754C12.2494 13.6985 12.254 13.9431 12.2909 14.0631C12.4571 14.6769 12.7478 15.7292 12.8632 15.96C13.0248 16.2877 13.1217 16.5 13.754 16.6016C14.3817 16.6985 16.2832 16.5462 16.514 16.4539C16.7448 16.3616 16.994 16.1908 17.1602 15.8908C17.3263 15.5908 17.5848 13.6754 17.5386 13.5277C17.4925 13.3754 16.6109 12.5723 14.534 12.7477Z" fill="#5C5C5C"/>
              <path d="M21.0094 6.7154H21.014C20.4371 5.98155 19.754 5.33078 18.9971 4.77232C19.7817 4.63386 20.3771 3.95078 20.3771 3.12924C20.3771 2.20617 19.6294 1.45386 18.7017 1.45386C17.774 1.45386 17.0263 2.20155 17.0263 3.12924C17.0263 3.31386 17.0632 3.48924 17.1186 3.6554C15.9278 3.09232 14.6263 2.72309 13.2648 2.58001C10.9848 2.34001 8.78323 2.74617 6.8863 3.64155C6.93707 3.48001 6.974 3.30924 6.974 3.12924C6.974 2.20617 6.2263 1.45386 5.29861 1.45386C4.37092 1.45386 3.62323 2.20155 3.62323 3.12924C3.62323 3.95078 4.214 4.62924 4.98938 4.77232C2.83861 6.36001 1.33861 8.67232 0.997074 11.3539C0.678612 13.8323 1.38477 16.3154 2.99092 18.3462C4.80938 20.6446 7.634 22.1539 10.7355 22.4816C11.1694 22.5277 11.5986 22.5508 12.0232 22.5508C17.5571 22.5508 22.3478 18.7939 23.0032 13.7077C23.3217 11.2292 22.6155 8.74617 21.0094 6.7154ZM12.0094 19.6892H12.0048C7.84169 19.6846 4.454 16.9062 4.454 13.4908C4.454 12.4616 4.76784 11.4739 5.33554 10.5969C5.38631 10.9108 5.47861 11.1831 5.58015 11.3862C5.71861 11.6631 5.99554 11.8246 6.2863 11.8246C6.40169 11.8246 6.52169 11.8016 6.63246 11.7462C7.02477 11.5569 7.1863 11.0862 7.0063 10.6939C6.90938 10.4862 6.66015 9.79847 7.26477 9.27232C7.85092 9.80309 8.69092 10.4262 9.63707 10.7308C11.4002 11.2892 12.734 10.9616 12.7894 10.9477C13.0571 10.8785 13.2648 10.68 13.3478 10.4169C13.4309 10.1539 13.3709 9.8677 13.1909 9.66463C12.3002 8.64001 11.8755 7.89232 11.6909 7.44001C15.3002 7.92924 15.9925 10.8046 16.0202 10.9339C16.0986 11.3031 16.4263 11.5569 16.7909 11.5569C16.8463 11.5569 16.8971 11.5523 16.9525 11.5385C17.3817 11.4508 17.654 11.0308 17.5663 10.6016C17.4555 10.0662 17.1648 9.34155 16.6478 8.61694C18.4155 9.75232 19.5602 11.5154 19.5602 13.4954C19.5602 16.9108 16.1725 19.6892 12.0094 19.6892Z" fill="#5C5C5C"/>
            </svg>
          </div>
          

        </div>
      </div>
    </header>

    <!-- App Navigation -->
    <nav class="slds-col slds-size_1-of-1 app-navigation">
      <div class="slds-grid slds-grid_align-spread" style="height: 100%;">
        
        <!-- App Name -->
        <div class="slds-grid slds-grid_vertical-align-center slds-p-left_medium">
          <span class="slds-text-body_regular slds-text-color_default">Sales</span>
        </div>

        <!-- Navigation Tabs -->
        <div class="slds-tabs_default slds-grow slds-m-left_large slds-p-right_medium">
          <ul class="slds-tabs_default__nav" role="tablist">
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="0" aria-selected="false">Home</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Contacts</a>
            </li>
            <li class="slds-tabs_default__item slds-is-active" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="true">Accounts</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Service</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Sales</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Calendar</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Dashboards</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Reports</a>
            </li>
          </ul>
        </div>


      </div>
    </nav>

    <!-- Page Header -->
    <div class="slds-col slds-size_1-of-1 slds-p-around_medium">
      <div class="slds-page-header">
        <div class="slds-grid slds-grid_align-spread">
          
          <!-- Object Info -->
          <div class="slds-grid slds-grid_vertical-align-center">
            <div class="slds-icon_container slds-icon-standard-account slds-m-right_small object-icon-container">
              <lightning-icon icon-name="standard:account" size="medium" variant="inverse"></lightning-icon>
            </div>
            <div>
              <p class="slds-text-body_small slds-text-color_weak">Accounts</p>
              <div class="slds-grid slds-grid_vertical-align-center">
                <h1 class="slds-text-heading_large">All Accounts</h1>
                <!-- AI Assistant Container -->
                <div class="ai-assistant-container">
                  <!-- AI Assistant Float -->
                  <div class="ai-assistant-float" onclick={handleAIAssistantClick} onkeydown={handleAIAssistantKeydown} role="button" tabindex="0" aria-label="AI Assistant - Get fundraising insights">
                    <svg width="14" height="14" viewBox="9 9 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M22.1815 16.4523L19.5673 17.7581C18.7811 18.1484 18.1485 18.7865 17.7554 19.57L16.4496 22.1815C16.2638 22.5531 15.7308 22.5531 15.545 22.1815L14.2392 19.57C13.8488 18.7865 13.2108 18.1511 12.4273 17.7581L9.81845 16.4523C9.44691 16.2665 9.44691 15.7334 9.81845 15.5477L12.4327 14.2419C13.2188 13.8515 13.8515 13.2134 14.2446 12.43L15.5477 9.81845C15.7334 9.44691 16.2665 9.44691 16.4523 9.81845L17.7581 12.43C18.1484 13.2134 18.7865 13.8488 19.57 14.2419L22.1842 15.5477C22.5558 15.7334 22.5558 16.2665 22.1842 16.4523H22.1815Z" fill="#0250D9"/>
                    </svg>
                  </div>
                  <!-- AI Popover -->
                  <template if:true={isPopoverOpen}>
                    <section class="slds-popover slds-nubbin_top" role="dialog" aria-label="AI Suggestions" aria-modal="true" style="position: absolute; top: 45px; left: 50%; transform: translateX(-50%); width: 320px; z-index: 1;">
                      <div class="slds-popover__header slds-p-vertical_small slds-p-horizontal_medium">
                        <div class="slds-media slds-media_center">
                          <div class="slds-media__figure">
                            <span class="slds-icon_container slds-icon-utility-sparkle">
                              <lightning-icon icon-name="utility:sparkle" size="x-small"></lightning-icon>
                            </span>
                          </div>
                          <div class="slds-media__body">
                            <h2 class="slds-text-heading_small">Let me help you...</h2>
                          </div>
                        </div>
                      </div>
                      <div class="slds-popover__body slds-p-vertical_large slds-p-horizontal_medium">
                        <lightning-button label="Sort by “Upgrade Potential”" onclick={handleAIPredictiveSort} data-sort-type="upgradePotential" class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Sort by “Churn Risk”" onclick={handleAIPredictiveSort} data-sort-type="churnRisk" class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Sort by “Likelihood to Give Again”" onclick={handleAIPredictiveSort} data-sort-type="likelihoodToGive" class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Filter by “Optimal Ask Range”" onclick={handleAIFilter} class="sds-button_stretch"></lightning-button>
                      </div>
                    </section>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="slds-grid slds-grid_vertical-align-center">
            <lightning-button-group>
              <lightning-button label="Edit" variant="neutral"></lightning-button>
              <lightning-button label="Delete" variant="neutral"></lightning-button>
              <lightning-button label="Clone" variant="neutral"></lightning-button>
              <lightning-button-menu alternative-text="Show more actions" variant="border-filled" icon-size="x-small">
                <lightning-menu-item value="action1" label="Action 1"></lightning-menu-item>
                <lightning-menu-item value="action2" label="Action 2"></lightning-menu-item>
              </lightning-button-menu>
            </lightning-button-group>
          </div>
        </div>

        <!-- Metadata and Search -->
        <div class="slds-grid slds-grid_align-spread slds-m-top_small">
          <div class="slds-grid slds-grid_vertical-align-center">
            <p class="slds-text-body_small slds-text-color_weak">
              100+ items • Sorted by Account Name • Filtered by All Accounts • Updated a few seconds ago
            </p>
          </div>
          
          <div class="slds-grid slds-grid_vertical-align-center">
            <!-- List Search -->
            <div class="slds-form-element slds-m-right_small" style="width: 300px;">
              <div class="slds-form-element__control slds-input-has-icon slds-input-has-icon_left">
                <lightning-icon icon-name="utility:search" size="x-small" class="slds-input__icon slds-input__icon_left"></lightning-icon>
                <input type="search" class="slds-input" placeholder="Search..." />
              </div>
            </div>
            
            <!-- Filter/Sort Actions -->
            <lightning-button-icon icon-name="utility:filterList" variant="border" alternative-text="Filter" class="slds-m-right_x-small"></lightning-button-icon>
            <lightning-button-icon icon-name="utility:sort" variant="border" alternative-text="Sort" class="slds-m-right_x-small"></lightning-button-icon>
            <lightning-button-icon icon-name="utility:refresh" variant="border" alternative-text="Refresh"></lightning-button-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview Bar -->
    <template if:true={showPreviewBar}>
      <div class="slds-col slds-size_1-of-1 slds-p-horizontal_medium slds-m-bottom_medium">
        <div class="slds-scoped-notification slds-media slds-media_center slds-theme_info" role="status">
          <div class="slds-media__figure">
            <lightning-icon icon-name="utility:arrowup" variant="inverse" size="small"></lightning-icon>
          </div>
          <div class="slds-media__body">
            <p if:false={isFiltered}>Sorted by Upgrade Potential: Top 30 Donors with High Scores</p>
            <p if:true={isFiltered}>Sorted by Upgrade Potential & Filtered to "Prefers In-person": {donorData.length} Donors</p>
          </div>
                      <div class="slds-media__figure slds-p-left_medium ask-popover-container">
                             <lightning-button label="Ask" variant="neutral" icon-name="utility:sparkles" icon-position="left" onclick={handlePreviewAsk} class="slds-m-right_x-small"></lightning-button>
              <template if:true={isAskPopoverOpen}>
                <section class="slds-popover" role="dialog">
                  <header class="slds-popover__header">
                    <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                      <h2 class="slds-text-heading_small">Ask</h2>
                      <lightning-button-icon icon-name="utility:close" variant="bare" alternative-text="Close Ask popover" onclick={handleAskPopoverClose} size="small"></lightning-button-icon>
                    </div>
                  </header>
                  <div class="slds-popover__body">
                    <lightning-textarea name="ask" label="Tell me what you need!"></lightning-textarea>
                    <div class="slds-m-top_medium">
                      <template if:false={isFiltered}>
                        <lightning-button label="Filter further to 'Prefers in-person'" onclick={handleFilterInPerson} class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Flag for Board Member Outreach" class="slds-button_stretch"></lightning-button>
                      </template>
                      <template if:true={isFiltered}>
                        <lightning-button label="Invite All to Exclusive Event" onclick={handleInviteToEvent} class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Assign to Major Gift Officer" onclick={handleAssignToMGO} class="slds-button_stretch"></lightning-button>
                      </template>
                    </div>
                  </div>
                  <footer class="slds-popover__footer slds-text-align_right">
                    <lightning-button label="Apply" variant="brand"></lightning-button>
                  </footer>
                </section>
              </template>
              <lightning-button label="Save" variant="neutral" onclick={handlePreviewSave} class="slds-m-right_x-small"></lightning-button>
              <lightning-button-icon icon-name="utility:close" variant="bare" alternative-text="Close preview" onclick={handlePreviewClose}></lightning-button-icon>
            </div>
        </div>
      </div>
    </template>

    <!-- Data Table -->
    <div class="slds-col slds-size_1-of-1 slds-p-horizontal_medium main-content">
      <div class="data-table-container slds-p-around_none">
        <lightning-datatable
          key-field="id"
          data={donorData}
          columns={columns}
          onrowselection={handleRowSelection}
          onsort={handleSort}
          sorted-by={sortedBy}
          sorted-direction={sortedDirection}
          show-row-number-column
          class="slds-table_bordered slds-table_col-bordered"
        ></lightning-datatable>
      </div>
    </div>

    <!-- Utility Bar -->
    <footer class="slds-col slds-size_1-of-1 utility-bar">
      <div class="slds-grid slds-grid_vertical-align-center slds-p-horizontal_medium" style="height: 100%;">
        <lightning-icon icon-name="utility:task" size="x-small" class="slds-m-right_x-small"></lightning-icon>
        <span class="slds-text-body_small">To Do List</span>
      </div>
    </footer>

    <!-- Agentforce Panel -->
    <template if:true={isAgentforcePanelOpen}>
      <div class="agentforce-panel">
        <!-- Header -->
        <div class="agentforce-header">
          <div class="agentforce-header-content">
            <div class="agentforce-title-section">
              <h2 class="agentforce-title">Agentforce</h2>
              <div class="agentforce-status-badge"></div>
            </div>
            <div class="agentforce-header-actions">
              <div class="agentforce-action-icon"></div>
              <div class="agentforce-action-icon"></div>
              <lightning-button-icon 
                icon-name="utility:close" 
                variant="bare" 
                alternative-text="Close Agentforce panel" 
                onclick={handleAgentforceClose} 
                size="small"
                class="agentforce-close-button">
              </lightning-button-icon>
            </div>
          </div>
        </div>
        
        <!-- Chat Container -->
        <div class="agentforce-chat-container">
          <!-- Expand Button -->
          <div class="agentforce-expand-section">
            <div class="agentforce-expand-button">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2308 2.2347V11.7655C10.2308 12.0347 9.88082 12.2232 9.63852 12.0078L3.93083 7.35008C3.71544 7.18854 3.71544 6.83854 3.93083 6.677L9.63852 1.96546C9.88082 1.777 10.2308 1.93854 10.2308 2.2347Z" fill="#0250D9"/>
              </svg>
            </div>
          </div>
          
          <!-- Messages -->
          <div class="agentforce-messages-container">
            <div class="agentforce-messages">
              <template for:each={chatMessages} for:item="message">
                <div key={message.id} class="agentforce-message">
                  <template if:true={message.isAI}>
                    <div class="agentforce-ai-message">
                      <div class="agentforce-ai-avatar">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M0 16C0 7.16344 7.16344 0 16 0V0C24.8366 0 32 7.16344 32 16V16C32 24.8366 24.8366 32 16 32V32C7.16344 32 0 24.8366 0 16V16Z" fill="#D6E6FF"/>
                          <path d="M18.1116 16.623H18.1193C17.8039 16.6499 17.5231 16.7037 17.2808 16.7807C17.2808 16.7807 16.927 16.8922 16.3847 16.9691C16.2577 16.9883 16.0962 16.9883 16.0077 16.9883H15.9424C15.8539 16.9883 15.6885 16.9807 15.5654 16.9614C15.0231 16.873 14.6731 16.7499 14.6731 16.7499C14.4308 16.673 14.15 16.6153 13.8347 16.5807C12.1077 16.4037 11.3616 17.0614 11.3193 17.1845C11.277 17.3076 11.4654 18.9076 11.6039 19.1614C11.7385 19.4114 11.9462 19.5576 12.1347 19.6383C12.327 19.7191 13.9077 19.8768 14.4347 19.8037C14.9616 19.7307 15.0424 19.5537 15.1847 19.2845C15.2847 19.0922 15.5424 18.223 15.6847 17.7114C15.7193 17.6114 15.7231 17.4114 15.9654 17.396C16.2077 17.4153 16.2116 17.6191 16.2424 17.7191C16.3808 18.2307 16.6231 19.1076 16.7193 19.2999C16.8539 19.573 16.9347 19.7499 17.4616 19.8345C17.9847 19.9153 19.5693 19.7884 19.7616 19.7114C19.9539 19.6345 20.1616 19.4922 20.3 19.2422C20.4385 18.9922 20.6539 17.396 20.6154 17.273C20.577 17.146 19.8424 16.4768 18.1116 16.623Z" fill="#0250D9"/>
                          <path d="M23.5077 11.596H23.5116C23.0308 10.9845 22.4616 10.4422 21.8308 9.97681C22.4847 9.86143 22.9808 9.2922 22.9808 8.60758C22.9808 7.83835 22.3577 7.21143 21.5847 7.21143C20.8116 7.21143 20.1885 7.8345 20.1885 8.60758C20.1885 8.76143 20.2193 8.90758 20.2654 9.04604C19.2731 8.57681 18.1885 8.26912 17.0539 8.14989C15.1539 7.94989 13.3193 8.28835 11.7385 9.0345C11.7808 8.89989 11.8116 8.75758 11.8116 8.60758C11.8116 7.83835 11.1885 7.21143 10.4154 7.21143C9.64235 7.21143 9.01927 7.8345 9.01927 8.60758C9.01927 9.2922 9.51158 9.85758 10.1577 9.97681C8.36543 11.2999 7.11543 13.2268 6.83081 15.4614C6.56543 17.5268 7.15389 19.596 8.49235 21.2883C10.0077 23.2037 12.3616 24.4614 14.9462 24.7345C15.3077 24.773 15.6654 24.7922 16.0193 24.7922C20.6308 24.7922 24.6231 21.6614 25.1693 17.423C25.4347 15.3576 24.8462 13.2883 23.5077 11.596ZM16.0077 22.4076H16.0039C12.5347 22.4037 9.71158 20.0883 9.71158 17.2422C9.71158 16.3845 9.97312 15.5614 10.4462 14.8307C10.4885 15.0922 10.5654 15.3191 10.65 15.4883C10.7654 15.7191 10.9962 15.8537 11.2385 15.8537C11.3347 15.8537 11.4347 15.8345 11.527 15.7883C11.8539 15.6307 11.9885 15.2383 11.8385 14.9114C11.7577 14.7383 11.55 14.1653 12.0539 13.7268C12.5424 14.1691 13.2424 14.6883 14.0308 14.9422C15.5 15.4076 16.6116 15.1345 16.6577 15.123C16.8808 15.0653 17.0539 14.8999 17.1231 14.6807C17.1924 14.4614 17.1424 14.223 16.9924 14.0537C16.25 13.1999 15.8962 12.5768 15.7424 12.1999C18.75 12.6076 19.327 15.0037 19.35 15.1114C19.4154 15.4191 19.6885 15.6307 19.9924 15.6307C20.0385 15.6307 20.0808 15.6268 20.127 15.6153C20.4847 15.5422 20.7116 15.1922 20.6385 14.8345C20.5462 14.3883 20.3039 13.7845 19.8731 13.1807C21.3462 14.1268 22.3 15.596 22.3 17.246C22.3 20.0922 19.477 22.4076 16.0077 22.4076Z" fill="#0250D9"/>
                        </svg>
                      </div>
                      <div class="agentforce-message-content">
                        <template if:true={message.isTyping}>
                          <div class="typing-indicator">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                          </div>
                        </template>
                        <template if:false={message.isTyping}>
                          <div class="agentforce-message-text" lwc:inner-html={message.content}></div>
                          <div class="agentforce-message-actions">
                            <button class="agentforce-view-details-button" onclick={handleViewDraftEmails} data-button-type={message.buttonLabel}>{message.buttonLabel}</button>
                            <div class="agentforce-message-buttons">
                              <div class="agentforce-message-action-icon"></div>
                              <div class="agentforce-message-action-icon"></div>
                              <div class="agentforce-message-action-icon"></div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </template>
                  
                  <template if:false={message.isAI}>
                    <div class="agentforce-user-message-container">
                      <div class="agentforce-user-avatar">
                        <lightning-icon icon-name="standard:user" size="small" class="slds-avatar__icon"></lightning-icon>
                      </div>
                      <div class="agentforce-message-content">
                        <div class="agentforce-message-text">{message.content}</div>
                        <div class="agentforce-message-actions">
                            <div class="agentforce-message-buttons">
                              <div class="agentforce-message-action-icon"></div>
                              <div class="agentforce-message-action-icon"></div>
                              <div class="agentforce-message-action-icon"></div>
                            </div>
                          </div>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </div>
        
        <!-- Input Section -->
        <div class="agentforce-input-section">
          <div class="agentforce-input-container">
            <div class="agentforce-input-field">
              <textarea 
                placeholder="Describe your task or ask a question…" 
                oninput={handleChatInputChange}
                onkeydown={handleChatInputKeydown}
                class="agentforce-textarea">
              </textarea>
              <div class="agentforce-send-button-container">
                <button 
                  onclick={handleSendMessage}
                  disabled={isChatInputEmpty}
                  class="agentforce-send-button">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0.646004 13.6924L1.99985 8.67697H7.72293C7.87677 8.67697 8.03062 8.52313 8.03062 8.36928V7.75389C8.03062 7.60005 7.87677 7.4462 7.72293 7.4462H1.99985L0.676773 2.52313C0.646004 2.46159 0.615234 2.36928 0.615234 2.27697C0.615234 2.06159 0.830619 1.8462 1.07677 1.87697C1.13831 1.87697 1.16908 1.90774 1.23062 1.90774L15.0768 7.60005C15.2614 7.66159 15.3845 7.8462 15.3845 8.03082C15.3845 8.21543 15.2614 8.36928 15.1075 8.43082L1.23062 14.277C1.16908 14.3077 1.10754 14.3077 1.046 14.3077C0.79985 14.277 0.615234 14.0924 0.615234 13.8462C0.615234 13.7847 0.615234 13.7539 0.646004 13.6924Z" fill="currentColor"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>

    <!-- Email Drafts Modal -->
    <template if:true={isEmailDraftsModalOpen}>
      <!-- Modal Backdrop -->
      <div class="slds-backdrop slds-backdrop_open" onclick={handleEmailDraftsModalClose}></div>
      
      <!-- Modal Container -->
      <div class="slds-modal slds-fade-in-open slds-modal_large" aria-hidden="false" role="dialog" aria-labelledby="modal-heading-01" aria-modal="true">
        <div class="slds-modal__container">
          <!-- Modal Header -->
          <div class="slds-modal__header">
            <h1 id="modal-heading-01" class="slds-modal__title slds-hyphenate">Email Drafts for In-Person Donors</h1>
            <lightning-button-icon 
              icon-name="utility:close" 
              variant="border-filled" 
              alternative-text="Close modal" 
              onclick={handleEmailDraftsModalClose}
              class="slds-modal__close">
            </lightning-button-icon>
          </div>
          
          <!-- Modal Body -->
          <div class="slds-modal__content slds-p-around_medium email-drafts-content">
            <div class="slds-text-body_regular slds-m-bottom_medium">
              <p><strong>8 personalized email invitations</strong> have been generated for your in-person preference donors. Each email is tailored based on their giving history, engagement level, and contact preferences.</p>
            </div>
            
            <!-- Email Drafts List -->
            <div class="email-drafts-list">
              <template for:each={emailDrafts} for:item="draft">
                <div key={draft.id} class="slds-card slds-m-bottom_medium email-draft-card">
                  <!-- Donor Info Header -->
                  <div class="slds-card__header">
                    <div class="slds-media slds-media_center">
                      <div class="slds-media__figure">
                        <lightning-icon icon-name="standard:contact" size="small"></lightning-icon>
                      </div>
                      <div class="slds-media__body">
                        <h2 class="slds-card__header-title">
                          <span class="slds-text-heading_small">{draft.donorName}</span>
                        </h2>
                        <div class="slds-text-body_small slds-text-color_weak">
                          {draft.donorType} • Lifetime Giving: ${draft.lifetimeGiving} • Engagement: {draft.engagementScore}/100
                        </div>
                      </div>
                      <div class="slds-media__figure slds-media__figure_reverse">
                        <lightning-button 
                          label="Send Email" 
                          variant="brand" 
                          onclick={handleSendEmail}
                          data-draft-id={draft.id}
                          class="slds-m-left_x-small">
                        </lightning-button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Email Content -->
                  <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-grid slds-gutters">
                      <!-- Email Draft Column -->
                      <div class="slds-col slds-size_1-of-2">
                        <div class="slds-form-element">
                          <div class="email-draft-header">
                            <label class="slds-form-element__label slds-text-title_caps" for={draft.id}>
                              <strong>Email Draft</strong>
                            </label>
                            <div class="refinement-button-container">
                              <button 
                                class="refinement-edit-button-custom" 
                                onclick={handleOpenRefinement}
                                data-draft-id={draft.id}
                                title="Refine with AI">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path fill-rule="evenodd" clip-rule="evenodd" d="M2.92217 10.2778L5.65936 13.0159C5.78237 13.1389 5.9669 13.1389 6.08992 13.0159L12.9175 6.15529C13.0405 6.03223 13.0405 5.84764 12.9175 5.72458L10.2111 3.01727C10.0881 2.89421 9.90353 2.89421 9.78051 3.01727L2.92217 9.87784C2.79915 10.0009 2.79915 10.1855 2.92217 10.2778V10.2778ZM11.1029 1.75598C10.9799 1.87904 10.9799 2.06363 11.1029 2.18669L13.8093 4.894C13.9323 5.01706 14.1169 5.01706 14.2399 4.894L15.0088 4.12488C15.5008 3.6634 15.5008 2.92505 15.0088 2.43281L13.5633 0.986855C13.0712 0.494616 12.3023 0.494616 11.8103 0.986855L11.1029 1.75598V1.75598ZM0.64633 14.8311C0.58482 15.1387 0.861614 15.4156 1.16916 15.3541L4.52145 14.5542C4.64447 14.5234 4.73673 14.4619 4.79824 14.4004L4.85975 14.3388C4.92126 14.2773 4.95202 14.062 4.829 13.9389L2.06106 11.1701C1.93804 11.047 1.72275 11.0778 1.66124 11.1393L1.59973 11.2008C1.50747 11.2931 1.47671 11.3854 1.44596 11.4777L0.64633 14.8311V14.8311Z" fill="#066AFE"/>
                                  <path d="M5.64933 3.19395L4.52895 3.75356C4.19202 3.92087 3.92087 4.19433 3.75241 4.5301L3.19279 5.64933C3.11318 5.80856 2.88471 5.80856 2.8051 5.64933L2.24548 4.5301C2.07818 4.19433 1.80471 3.92202 1.46895 3.75356L0.350868 3.19395C0.191638 3.11433 0.191638 2.88587 0.350868 2.80625L1.47125 2.24664C1.80818 2.07933 2.07933 1.80587 2.24779 1.4701L2.80625 0.350868C2.88587 0.191638 3.11433 0.191638 3.19395 0.350868L3.75356 1.4701C3.92087 1.80587 4.19433 2.07818 4.5301 2.24664L5.65048 2.80625C5.80972 2.88587 5.80972 3.11433 5.65048 3.19395H5.64933Z" fill="#066AFE"/>
                                </svg>
                              </button>
                              
                              <!-- Refinement Popover - Only show for current draft -->
                              <template if:true={draft.showPopover}>
                                <div class="refinement-popover-container">
                                        <div class="slds-popover slds-popover_medium refinement-popover" role="dialog">
                                          <!-- Popover Header -->
                                          <div class="slds-popover__header">
                                            <h2 class="slds-text-heading_small">Modify Draft</h2>
                                          </div>
                                          
                                          <!-- Popover Body -->
                                          <div class="slds-popover__body">
                                            <!-- Custom Prompt Input -->
                                            <div class="slds-form-element slds-m-bottom_medium">
                                                                                          <textarea 
                                              class="slds-textarea" 
                                              placeholder="Modify with a prompt"
                                              value={refinementPrompt}
                                              onchange={handleRefinementPromptChange}
                                              onkeydown={handlePromptKeyDown}
                                              rows="3">
                                            </textarea>
                                            </div>
                                            
                                            <!-- Preset Options -->
                                            <div class="refinement-options">
                                              <div class="refinement-option" onclick={handleRefinementOption} data-option="rephrase">
                                                <lightning-icon icon-name="utility:refresh" size="x-small" class="refinement-option-icon"></lightning-icon>
                                                <span>Rephrase</span>
                                              </div>
                                              <div class="refinement-option" onclick={handleRefinementOption} data-option="shorten">
                                                <lightning-icon icon-name="utility:contract" size="x-small" class="refinement-option-icon"></lightning-icon>
                                                <span>Shorten</span>
                                              </div>
                                              <div class="refinement-option" onclick={handleRefinementOption} data-option="elaborate">
                                                <lightning-icon icon-name="utility:expand" size="x-small" class="refinement-option-icon"></lightning-icon>
                                                <span>Elaborate</span>
                                              </div>
                                              <div class="refinement-option" onclick={handleRefinementOption} data-option="formal">
                                                <lightning-icon icon-name="utility:user" size="x-small" class="refinement-option-icon"></lightning-icon>
                                                <span>More formal</span>
                                              </div>
                                              <div class="refinement-option" onclick={handleRefinementOption} data-option="casual">
                                                <lightning-icon icon-name="utility:chat" size="x-small" class="refinement-option-icon"></lightning-icon>
                                                <span>More casual</span>
                                              </div>
                                              <div class="refinement-option" onclick={handleRefinementOption} data-option="bulletize">
                                                <lightning-icon icon-name="utility:list" size="x-small" class="refinement-option-icon"></lightning-icon>
                                                <span>Bulletize</span>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                </div>
                              </template>
                            </div>
                          </div>
                          <div class="slds-form-element__control">
                            <!-- Subject Line -->
                            <div class="slds-m-bottom_small">
                              <label class="slds-form-element__label slds-text-body_small">Subject:</label>
                              <input type="text" class="slds-input email-subject" value={draft.subject} readonly />
                            </div>
                            <!-- Email Body -->
                            <textarea 
                              id={draft.id}
                              class="slds-textarea email-body-textarea" 
                              rows="12"
                              onchange={handleEmailEdit}
                              data-draft-id={draft.id}>{draft.emailBody}</textarea>
                          </div>
                        </div>
                      </div>
                      
                      <!-- AI Explanation Column -->
                      <div class="slds-col slds-size_1-of-2">
                        <div class="slds-form-element">
                          <label class="slds-form-element__label slds-text-title_caps">
                            <strong>AI Personalization Insights</strong>
                          </label>
                          <div class="slds-box slds-theme_shade ai-explanation-box">
                            <div class="slds-text-body_small ai-explanation-text" lwc:inner-html={draft.aiExplanation}></div>
                          </div>
                        </div>
                        
                        <!-- Donor Details -->
                        <div class="slds-m-top_medium">
                          <h3 class="slds-text-title_caps slds-m-bottom_x-small"><strong>Donor Profile</strong></h3>
                          <ul class="slds-list_dotted slds-text-body_small">
                            <li><strong>Type:</strong> {draft.donorType}</li>
                            <li><strong>Lifetime Giving:</strong> ${draft.lifetimeGiving}</li>
                            <li><strong>Engagement Score:</strong> {draft.engagementScore}/100</li>
                            <li><strong>Last Gift:</strong> {draft.lastGiftDate}</li>
                            <li><strong>Preferred Contact:</strong> In-person</li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="slds-modal__footer">
            <lightning-button 
              label="Close" 
              onclick={handleEmailDraftsModalClose}
              class="slds-m-right_x-small">
            </lightning-button>
            <lightning-button 
              label="Send All Emails" 
              variant="brand"
              onclick={handleSendAllEmails}>
            </lightning-button>
          </div>
        </div>
      </div>
    </template>
  </div>
</template>