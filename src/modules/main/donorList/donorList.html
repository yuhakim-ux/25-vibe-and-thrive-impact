<template>
  <div class={containerClass}>
    
    <!-- Global Header -->
    <header class="slds-col slds-size_1-of-1 global-header">
      <div class="slds-grid slds-grid_align-spread slds-p-horizontal_medium slds-p-vertical_x-small" style="height: 100%;">
        
        <!-- Logo -->
        <div class="slds-grid slds-grid_vertical-align-center">
          <svg width="46" height="32" viewBox="0 0 61 42" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M25.524 4.65374C27.5144 2.6759 30.2073 1.39612 33.2514 1.39612C37.2322 1.39612 40.7447 3.60665 42.618 6.86427C44.2572 6.1662 46.0134 5.70083 47.8868 5.70083C55.1459 5.70083 61 11.518 61 18.7313C61 25.9446 55.1459 31.7618 47.8868 31.7618C46.9501 31.7618 46.1305 31.6454 45.3109 31.5291C43.6718 34.4377 40.5106 36.4155 36.881 36.4155C35.3589 36.4155 33.9539 36.0665 32.666 35.4848C31.0269 39.3241 27.1631 42 22.5969 42C17.9136 42 13.8157 39.0914 12.2937 34.903C11.5912 35.0194 10.8887 35.1357 10.1862 35.1357C4.56622 35.1357 0 30.5983 0 25.0139C0 21.2909 1.9904 18.0332 5.03455 16.2881C4.44914 14.892 4.09789 13.2632 4.09789 11.6343C4.09789 5.23546 9.3666 0 15.9232 0C20.0211 0.116343 23.4165 1.8615 25.524 4.65374Z" fill="#00A1E0"/>
          </svg>
        </div>

        <!-- Global Search -->
        <div class="slds-grid slds-grid_vertical-align-center slds-grow">
          <div class="slds-form-element slds-m-left_large" style="width: 400px;">
            <div class="slds-form-element__control slds-input-has-icon slds-input-has-icon_left">
              <lightning-icon icon-name="utility:search" size="x-small" class="slds-input__icon slds-input__icon_left"></lightning-icon>
              <input type="search" class="slds-input" placeholder="Search..." />
            </div>
          </div>
        </div>

        <!-- Utility Icons -->
        <div class="slds-grid slds-grid_vertical-align-center">
          <lightning-button-icon icon-name="utility:notification" variant="container" alternative-text="Notifications" class="slds-m-right_x-small"></lightning-button-icon>
          <lightning-button-icon icon-name="utility:help" variant="container" alternative-text="Help" class="slds-m-right_x-small"></lightning-button-icon>
          <lightning-button-icon icon-name="utility:settings" variant="container" alternative-text="Settings" class="slds-m-right_x-small"></lightning-button-icon>
          <lightning-avatar size="small" src="" fallback-icon-name="utility:user" alternative-text="User"></lightning-avatar>
          
          <!-- View Toggle -->
          <div class="slds-button-group slds-m-left_medium" role="group" aria-label="View Options">
            <lightning-button-icon icon-name="utility:apps" variant="border" alternative-text="Grid View"></lightning-button-icon>
            <lightning-button-icon icon-name="utility:list" variant="border-filled" alternative-text="List View"></lightning-button-icon>
          </div>
        </div>
      </div>
    </header>

    <!-- App Navigation -->
    <nav class="slds-col slds-size_1-of-1 app-navigation">
      <div class="slds-grid slds-grid_align-spread slds-p-horizontal_medium" style="height: 100%;">
        
        <!-- App Name -->
        <div class="slds-grid slds-grid_vertical-align-center">
          <span class="slds-text-body_regular slds-text-color_default">Sales</span>
        </div>

        <!-- Navigation Tabs -->
        <div class="slds-tabs_default slds-grow slds-m-left_large">
          <ul class="slds-tabs_default__nav" role="tablist">
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="0" aria-selected="false">Home</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Contacts</a>
            </li>
            <li class="slds-tabs_default__item slds-is-active" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="true">Accounts</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Service</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Sales</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Calendar</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Dashboards</a>
            </li>
            <li class="slds-tabs_default__item" role="presentation">
              <a class="slds-tabs_default__link" href="#" role="tab" tabindex="-1" aria-selected="false">Reports</a>
            </li>
          </ul>
        </div>

        <!-- Edit Button -->
        <div class="slds-grid slds-grid_vertical-align-center">
          <lightning-button label="Edit" variant="neutral"></lightning-button>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    <div class="slds-col slds-size_1-of-1 slds-p-around_medium">
      <div class="slds-page-header">
        <div class="slds-grid slds-grid_align-spread">
          
          <!-- Object Info -->
          <div class="slds-grid slds-grid_vertical-align-center">
            <div class="slds-icon_container slds-icon-standard-account slds-m-right_small object-icon-container">
              <lightning-icon icon-name="standard:account" size="medium" variant="inverse"></lightning-icon>
            </div>
            <div>
              <p class="slds-text-body_small slds-text-color_weak">Accounts</p>
              <div class="slds-grid slds-grid_vertical-align-center">
                <h1 class="slds-text-heading_large">All Accounts</h1>
                <!-- AI Assistant Container -->
                <div class="ai-assistant-container">
                  <!-- AI Assistant Float -->
                  <div class="ai-assistant-float" onclick={handleAIAssistantClick} onkeydown={handleAIAssistantKeydown} role="button" tabindex="0" aria-label="AI Assistant - Get fundraising insights">
                    <svg width="14" height="14" viewBox="9 9 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M22.1815 16.4523L19.5673 17.7581C18.7811 18.1484 18.1485 18.7865 17.7554 19.57L16.4496 22.1815C16.2638 22.5531 15.7308 22.5531 15.545 22.1815L14.2392 19.57C13.8488 18.7865 13.2108 18.1511 12.4273 17.7581L9.81845 16.4523C9.44691 16.2665 9.44691 15.7334 9.81845 15.5477L12.4327 14.2419C13.2188 13.8515 13.8515 13.2134 14.2446 12.43L15.5477 9.81845C15.7334 9.44691 16.2665 9.44691 16.4523 9.81845L17.7581 12.43C18.1484 13.2134 18.7865 13.8488 19.57 14.2419L22.1842 15.5477C22.5558 15.7334 22.5558 16.2665 22.1842 16.4523H22.1815Z" fill="#0250D9"/>
                    </svg>
                  </div>
                  <!-- AI Popover -->
                  <template if:true={isPopoverOpen}>
                    <section class="slds-popover slds-nubbin_top" role="dialog" aria-label="AI Suggestions" aria-modal="true" style="position: absolute; top: 45px; left: 50%; transform: translateX(-50%); width: 320px; z-index: 1;">
                      <div class="slds-popover__header slds-p-vertical_small slds-p-horizontal_medium">
                        <div class="slds-media slds-media_center">
                          <div class="slds-media__figure">
                            <span class="slds-icon_container slds-icon-utility-sparkle">
                              <lightning-icon icon-name="utility:sparkle" size="x-small"></lightning-icon>
                            </span>
                          </div>
                          <div class="slds-media__body">
                            <h2 class="slds-text-heading_small">Let me help you...</h2>
                          </div>
                        </div>
                      </div>
                      <div class="slds-popover__body slds-p-vertical_large slds-p-horizontal_medium">
                        <lightning-button label="Sort by “Upgrade Potential”" onclick={handleAIPredictiveSort} data-sort-type="upgradePotential" class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Sort by “Churn Risk”" onclick={handleAIPredictiveSort} data-sort-type="churnRisk" class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Sort by “Likelihood to Give Again”" onclick={handleAIPredictiveSort} data-sort-type="likelihoodToGive" class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Filter by “Optimal Ask Range”" onclick={handleAIFilter} class="sds-button_stretch"></lightning-button>
                      </div>
                    </section>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="slds-grid slds-grid_vertical-align-center">
            <lightning-button-group>
              <lightning-button label="Edit" variant="neutral"></lightning-button>
              <lightning-button label="Delete" variant="neutral"></lightning-button>
              <lightning-button label="Clone" variant="neutral"></lightning-button>
              <lightning-button-menu alternative-text="Show more actions" variant="border-filled" icon-size="x-small">
                <lightning-menu-item value="action1" label="Action 1"></lightning-menu-item>
                <lightning-menu-item value="action2" label="Action 2"></lightning-menu-item>
              </lightning-button-menu>
            </lightning-button-group>
          </div>
        </div>

        <!-- Metadata and Search -->
        <div class="slds-grid slds-grid_align-spread slds-m-top_small">
          <div class="slds-grid slds-grid_vertical-align-center">
            <p class="slds-text-body_small slds-text-color_weak">
              100+ items • Sorted by Account Name • Filtered by All Accounts • Updated a few seconds ago
            </p>
          </div>
          
          <div class="slds-grid slds-grid_vertical-align-center">
            <!-- List Search -->
            <div class="slds-form-element slds-m-right_small" style="width: 300px;">
              <div class="slds-form-element__control slds-input-has-icon slds-input-has-icon_left">
                <lightning-icon icon-name="utility:search" size="x-small" class="slds-input__icon slds-input__icon_left"></lightning-icon>
                <input type="search" class="slds-input" placeholder="Search..." />
              </div>
            </div>
            
            <!-- Filter/Sort Actions -->
            <lightning-button-icon icon-name="utility:filterList" variant="border" alternative-text="Filter" class="slds-m-right_x-small"></lightning-button-icon>
            <lightning-button-icon icon-name="utility:sort" variant="border" alternative-text="Sort" class="slds-m-right_x-small"></lightning-button-icon>
            <lightning-button-icon icon-name="utility:refresh" variant="border" alternative-text="Refresh"></lightning-button-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview Bar -->
    <template if:true={showPreviewBar}>
      <div class="slds-col slds-size_1-of-1 slds-p-horizontal_medium slds-m-bottom_medium">
        <div class="slds-scoped-notification slds-media slds-media_center slds-theme_info" role="status">
          <div class="slds-media__figure">
            <lightning-icon icon-name="utility:arrowup" variant="inverse" size="small"></lightning-icon>
          </div>
          <div class="slds-media__body">
            <p if:false={isFiltered}>Sorted by Upgrade Potential: Top 30 Donors with High Scores</p>
            <p if:true={isFiltered}>Sorted by Upgrade Potential & Filtered to "Prefers In-person": {donorData.length} Donors</p>
          </div>
                      <div class="slds-media__figure slds-p-left_medium ask-popover-container">
              <lightning-button label="Ask" variant="brand" onclick={handlePreviewAsk} class="slds-m-right_x-small"></lightning-button>
              <template if:true={isAskPopoverOpen}>
                <section class="slds-popover" role="dialog">
                  <header class="slds-popover__header">
                    <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                      <h2 class="slds-text-heading_small">Ask</h2>
                      <lightning-button-icon icon-name="utility:close" variant="bare" alternative-text="Close Ask popover" onclick={handleAskPopoverClose} size="small"></lightning-button-icon>
                    </div>
                  </header>
                  <div class="slds-popover__body">
                    <lightning-textarea name="ask" label="Tell me what you need!"></lightning-textarea>
                    <div class="slds-m-top_medium">
                      <template if:false={isFiltered}>
                        <lightning-button label="Filter further to 'Prefers in-person'" onclick={handleFilterInPerson} class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Flag for Board Member Outreach" class="slds-button_stretch"></lightning-button>
                      </template>
                      <template if:true={isFiltered}>
                        <lightning-button label="Invite All to Exclusive Event" onclick={handleInviteToEvent} class="slds-button_stretch slds-m-bottom_small"></lightning-button>
                        <lightning-button label="Assign to Major Gift Officer" onclick={handleAssignToMGO} class="slds-button_stretch"></lightning-button>
                      </template>
                    </div>
                  </div>
                  <footer class="slds-popover__footer slds-text-align_right">
                    <lightning-button label="Apply" variant="brand"></lightning-button>
                  </footer>
                </section>
              </template>
              <lightning-button label="Save" variant="neutral" onclick={handlePreviewSave} class="slds-m-right_x-small"></lightning-button>
              <lightning-button-icon icon-name="utility:close" variant="bare" alternative-text="Close preview" onclick={handlePreviewClose}></lightning-button-icon>
            </div>
        </div>
      </div>
    </template>

    <!-- Data Table -->
    <div class="slds-col slds-size_1-of-1 slds-p-horizontal_medium main-content">
      <div class="data-table-container slds-p-around_none">
        <lightning-datatable
          key-field="id"
          data={donorData}
          columns={columns}
          onrowselection={handleRowSelection}
          onsort={handleSort}
          sorted-by={sortedBy}
          sorted-direction={sortedDirection}
          show-row-number-column
          class="slds-table_bordered slds-table_col-bordered"
        ></lightning-datatable>
      </div>
    </div>

    <!-- Utility Bar -->
    <footer class="slds-col slds-size_1-of-1 utility-bar">
      <div class="slds-grid slds-grid_vertical-align-center slds-p-horizontal_medium" style="height: 100%;">
        <lightning-icon icon-name="utility:task" size="x-small" class="slds-m-right_x-small"></lightning-icon>
        <span class="slds-text-body_small">To Do List</span>
      </div>
    </footer>

    <!-- Agentforce Panel -->
    <template if:true={isAgentforcePanelOpen}>
      <div class="agentforce-panel">
        <!-- Header -->
        <div class="agentforce-header">
          <div class="agentforce-header-content">
            <div class="agentforce-title-section">
              <h2 class="agentforce-title">Agentforce</h2>
              <div class="agentforce-status-badge"></div>
            </div>
            <div class="agentforce-header-actions">
              <div class="agentforce-action-icon"></div>
              <div class="agentforce-action-icon"></div>
              <lightning-button-icon 
                icon-name="utility:close" 
                variant="bare" 
                alternative-text="Close Agentforce panel" 
                onclick={handleAgentforceClose} 
                size="small"
                class="agentforce-close-button">
              </lightning-button-icon>
            </div>
          </div>
        </div>
        
        <!-- Chat Container -->
        <div class="agentforce-chat-container">
          <!-- Expand Button -->
          <div class="agentforce-expand-section">
            <div class="agentforce-expand-button">
              <div class="agentforce-expand-icon"></div>
            </div>
          </div>
          
          <!-- Messages -->
          <div class="agentforce-messages-container">
            <div class="agentforce-messages">
              <template for:each={chatMessages} for:item="message">
                <div key={message.id} class="agentforce-message">
                  <template if:true={message.isAI}>
                    <div class="agentforce-ai-message">
                      <div class="agentforce-ai-avatar">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M0 16C0 7.16344 7.16344 0 16 0V0C24.8366 0 32 7.16344 32 16V16C32 24.8366 24.8366 32 16 32V32C7.16344 32 0 24.8366 0 16V16Z" fill="#D6E6FF"/>
                          <path d="M18.1116 16.623H18.1193C17.8039 16.6499 17.5231 16.7037 17.2808 16.7807C17.2808 16.7807 16.927 16.8922 16.3847 16.9691C16.2577 16.9883 16.0962 16.9883 16.0077 16.9883H15.9424C15.8539 16.9883 15.6885 16.9807 15.5654 16.9614C15.0231 16.873 14.6731 16.7499 14.6731 16.7499C14.4308 16.673 14.15 16.6153 13.8347 16.5807C12.1077 16.4037 11.3616 17.0614 11.3193 17.1845C11.277 17.3076 11.4654 18.9076 11.6039 19.1614C11.7385 19.4114 11.9462 19.5576 12.1347 19.6383C12.327 19.7191 13.9077 19.8768 14.4347 19.8037C14.9616 19.7307 15.0424 19.5537 15.1847 19.2845C15.2847 19.0922 15.5424 18.223 15.6847 17.7114C15.7193 17.6114 15.7231 17.4114 15.9654 17.396C16.2077 17.4153 16.2116 17.6191 16.2424 17.7191C16.3808 18.2307 16.6231 19.1076 16.7193 19.2999C16.8539 19.573 16.9347 19.7499 17.4616 19.8345C17.9847 19.9153 19.5693 19.7884 19.7616 19.7114C19.9539 19.6345 20.1616 19.4922 20.3 19.2422C20.4385 18.9922 20.6539 17.396 20.6154 17.273C20.577 17.146 19.8424 16.4768 18.1116 16.623Z" fill="#0250D9"/>
                          <path d="M23.5077 11.596H23.5116C23.0308 10.9845 22.4616 10.4422 21.8308 9.97681C22.4847 9.86143 22.9808 9.2922 22.9808 8.60758C22.9808 7.83835 22.3577 7.21143 21.5847 7.21143C20.8116 7.21143 20.1885 7.8345 20.1885 8.60758C20.1885 8.76143 20.2193 8.90758 20.2654 9.04604C19.2731 8.57681 18.1885 8.26912 17.0539 8.14989C15.1539 7.94989 13.3193 8.28835 11.7385 9.0345C11.7808 8.89989 11.8116 8.75758 11.8116 8.60758C11.8116 7.83835 11.1885 7.21143 10.4154 7.21143C9.64235 7.21143 9.01927 7.8345 9.01927 8.60758C9.01927 9.2922 9.51158 9.85758 10.1577 9.97681C8.36543 11.2999 7.11543 13.2268 6.83081 15.4614C6.56543 17.5268 7.15389 19.596 8.49235 21.2883C10.0077 23.2037 12.3616 24.4614 14.9462 24.7345C15.3077 24.773 15.6654 24.7922 16.0193 24.7922C20.6308 24.7922 24.6231 21.6614 25.1693 17.423C25.4347 15.3576 24.8462 13.2883 23.5077 11.596ZM16.0077 22.4076H16.0039C12.5347 22.4037 9.71158 20.0883 9.71158 17.2422C9.71158 16.3845 9.97312 15.5614 10.4462 14.8307C10.4885 15.0922 10.5654 15.3191 10.65 15.4883C10.7654 15.7191 10.9962 15.8537 11.2385 15.8537C11.3347 15.8537 11.4347 15.8345 11.527 15.7883C11.8539 15.6307 11.9885 15.2383 11.8385 14.9114C11.7577 14.7383 11.55 14.1653 12.0539 13.7268C12.5424 14.1691 13.2424 14.6883 14.0308 14.9422C15.5 15.4076 16.6116 15.1345 16.6577 15.123C16.8808 15.0653 17.0539 14.8999 17.1231 14.6807C17.1924 14.4614 17.1424 14.223 16.9924 14.0537C16.25 13.1999 15.8962 12.5768 15.7424 12.1999C18.75 12.6076 19.327 15.0037 19.35 15.1114C19.4154 15.4191 19.6885 15.6307 19.9924 15.6307C20.0385 15.6307 20.0808 15.6268 20.127 15.6153C20.4847 15.5422 20.7116 15.1922 20.6385 14.8345C20.5462 14.3883 20.3039 13.7845 19.8731 13.1807C21.3462 14.1268 22.3 15.596 22.3 17.246C22.3 20.0922 19.477 22.4076 16.0077 22.4076Z" fill="#0250D9"/>
                        </svg>
                      </div>
                      <div class="agentforce-message-content">
                        <template if:true={message.isTyping}>
                          <div class="typing-indicator">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                          </div>
                        </template>
                        <template if:false={message.isTyping}>
                          <div class="agentforce-message-text" lwc:inner-html={message.content}></div>
                          <div class="agentforce-message-actions">
                            <button class="agentforce-view-details-button">View Details</button>
                            <div class="agentforce-message-buttons">
                              <div class="agentforce-message-action-icon"></div>
                              <div class="agentforce-message-action-icon"></div>
                              <div class="agentforce-message-action-icon"></div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </template>
                  
                  <template if:false={message.isAI}>
                    <div class="agentforce-user-message">
                      <div class="agentforce-user-message-content">
                        <div class="agentforce-user-message-text">{message.content}</div>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </div>
        
        <!-- Input Section -->
        <div class="agentforce-input-section">
          <div class="agentforce-input-container">
            <div class="agentforce-input-field">
              <textarea 
                placeholder="Describe your task or ask a question…" 
                value={chatInputValue}
                onchange={handleChatInputChange}
                onkeydown={handleChatInputKeydown}
                class="agentforce-textarea">
              </textarea>
              <div class="agentforce-send-button-container">
                <button 
                  onclick={handleSendMessage}
                  disabled={isChatInputEmpty}
                  class="agentforce-send-button">
                  <div class="agentforce-send-icon"></div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>
</template>